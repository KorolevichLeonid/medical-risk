# Новая структура авторизации

## Обзор изменений

Система авторизации была полностью переработана для разделения системных и проектных ролей.

## Системные роли

### 1. USER (по умолчанию)
- **Присваивается**: Автоматически всем новым пользователям при входе через Azure Entra
- **Права**:
  - Создание собственных проектов
  - Просмотр только своих проектов
  - Просмотр пользователей, участвующих в их проектах
  - Просмотр логов только своих проектов (которые создал)
  - Редактирование только личной информации

### 2. SYS_ADMIN (системный администратор)
- **Присваивается**: Только другим системным администратором
- **Права**:
  - Просмотр всех проектов в системе
  - Просмотр всех пользователей
  - Просмотр всех логов всех проектов
  - Повышение пользователей до роли SYS_ADMIN
  - Полный контроль над системой

## Проектные роли

В каждом проекте пользователи могут иметь одну из трех ролей:

### 1. ADMIN (создатель проекта)
- **Присваивается**: Автоматически пользователю, создавшему проект
- **Права**:
  - Полный контроль над проектом
  - Редактирование данных проекта
  - Добавление/удаление участников проекта
  - Управление рисками (создание/редактирование/удаление)
  - Просмотр всех логов проекта
  - Просмотр всех участников проекта

### 2. MANAGER (менеджер проекта)
- **Присваивается**: Владельцем проекта или другим менеджером
- **Права**:
  - Редактирование данных проекта
  - Добавление/удаление участников проекта
  - Просмотр рисков (без возможности редактирования)
  - Просмотр участников проекта
  - **НЕТ доступа к логам проекта**
  - **НЕТ возможности управлять рисками**

### 3. DOCTOR (доктор) - по умолчанию
- **Присваивается**: По умолчанию при добавлении в проект
- **Права**:
  - Создание/редактирование/удаление рисков
  - Просмотр участников проекта
  - **НЕТ доступа к редактированию данных проекта**
  - **НЕТ доступа к управлению участниками**
  - **НЕТ доступа к логам проекта**

## Изменения в коде

### Модели
- `UserRole`: Обновлена с `USER` и `SYS_ADMIN`
- `ProjectRole`: Новый enum с `ADMIN`, `MANAGER`, `DOCTOR`
- `User.role`: Теперь по умолчанию `USER`
- `ProjectMember.role`: Теперь использует `ProjectRole` enum

### Разрешения
- Создание проектов: Все пользователи (вместо только админов)
- Доступ к логам: Только владельцы проектов и сис админы
- Управление рисками: Доктора и админы проектов
- Управление участниками: Менеджеры и админы проектов

### Миграция данных
- Все существующие пользователи с ролями ADMIN, DOCTOR, MANAGER стали USER
- Существующие SYS_ADMIN остались SYS_ADMIN
- Пользователи с NULL ролью стали USER
- Участники проектов получили корректные проектные роли

## Безопасность

1. **Azure Entra интеграция**: Все новые пользователи автоматически получают роль USER
2. **Минимальные права**: Пользователи имеют доступ только к необходимому минимуму
3. **Разделение ответственности**: Четкое разделение между системными и проектными правами
4. **Аудит**: Полное логирование всех действий с контролем доступа

## Следующие шаги

1. Обновить фронтенд для поддержки новой структуры ролей
2. Протестировать все сценарии использования
3. Обновить документацию API
4. Провести обучение пользователей новой системе ролей
